define(["jquery","dialog","jqform"],function(e,i){var t={},a=window.navigator.userAgent;a.indexOf("MSIE 8.0")>0?t.ie=!0:a.indexOf("Firefox")>=1?t.firefox=!0:a.indexOf("Chrome")>=1&&(t.chrome=!0);var n=function(){};return n.removeHandler=function(i){i.preventDefault();var t=e(this).data("filegroup"),a=e("#"+t).data("filecount");a-=1,e("#"+t).data("filecount",a),e(this).closest(".form-group").remove()},n.chageHandler=function(){return n.checkFileSize(this)&&n.checkFileType(this)?void n.setFileName(this):void n.resetFile(this)},n.setFileName=function(a){var n=e(a),l="";if(t.ie){if(""===a.value)return i.alert("上传文件不能为空！"),!1;l=a.value,l=l.substring(l.lastIndexOf("\\")+1)}else{var r=void 0!==n[0].files?n[0].files[0]:"";if(""===r)return i.alert("上传文件不能为空！"),!1;l=r.name}n.closest(".form-group").find(".file-input-label").val(l.replace(/\, $/g,""))},n.resetFile=function(i){var t=e(i);t.val(""),t.closest(".form-group").find(".file-input-label").val("")},n.checkFileSize=function(a){var n=e(a),l=n.data("filesize")?n.data("filesize"):2097152;if(t.ie)return""!==a.value||(i.alert("上传文件不能为空！"),!1);var r=void 0!==n[0].files?n[0].files[0]:"";if(""===r)return i.alert("上传文件不能为空！"),!1;if(r.size>l){var o=parseInt(l)/1024;return i.alert("上传文件大小不能超过"+o.toFixed(0)+"KB,请重新选择!"),!1}return!0},n.checkFileType=function(a){var n=e(a),l=n.data("filetype")?n.data("filetype").split("|"):"";if(""===l)return!0;var r="";if(t.ie){if(""===a.value)return i.alert("上传文件不能为空！"),!1;r=a.value}else{var o=void 0!==n[0].files?n[0].files[0]:"";if(""===o)return i.alert("上传文件不能为空！"),!1;r=o.name}var f=r.lastIndexOf(".")+1,d=r.substring(f,r.length).toLowerCase();return-1!==e.inArray(d,l)||(i.alert("上传文件限于 "+l.join(",")+" 格式,请重新选择!"),!1)},n.downFile=function(i,t){if(e.isEmptyObject(i))throw new Error("附件id不能为空");var a=webAppPath+"/common/file/down";null!=t&&void 0!==t||(t=""),jQuery('<form action="'+a+'" method="post"><input type="hidden" name="fileId" value="'+i+'"/><input type="hidden" name="fileName" value="'+t+'"/></form>').appendTo("body").submit().remove()},n.showImg=function(t){var a=webAppPath+"/common/file/show?fileId="+t,n=e('<img style="max-width:578px"/>').attr("src",a),l=e("<div></div>").append(n);i.show({title:"图片预览",size:i.SIZE_NORMAL,closable:!1,message:l,buttons:[{label:"关闭",cssClass:"btn-default",autospin:!0,action:function(e){e.close()}}]});e("#dialog-load").remove()},n.init=function(){e(".file-input").each(function(){var i=e(this);i.off("change"),i.on("change",n.chageHandler)}),e(".file-append").off("click"),e(".file-append").click(function(t){t.preventDefault();var a=e(this).closest(".form-group").find(".file-input"),l=a.data("maxfiles"),r=l?parseInt(l):n.MaxFileCount,o=a.data("filecount"),f=o?parseInt(o):1;if(f>=r)return void i.alert("最多允许上传"+r+"个附件。");f+=1,n.AddCount+=1,a.data("filecount",f);var d=e(this).closest(".form-group").clone(),u=d.find(".file-input").attr("id");kk=d.find(".file-goodsImg").attr("id");d.find(".file-goodsImg").attr("id",kk+n.AddCount);d.find(".file-goodsImg").attr("src","../../images/timg.jpg");d.find(".file-input").attr("id",u+n.AddCount).val("").on("change",n.chageHandler),d.children("label").text(""),d.find(".file-input-label").val(""),d.find(".file-input-label-for").attr("for",u+n.AddCount);var s=e("<a class='btn btn-link-red file-remove'><i class='fa fa-times-circle fa-lg' aria-hidden='true'></i></a>").on("click",n.removeHandler);s.data("filegroup",u);var c=d.find(".file-append");c.after(s),c.remove(),e(this).closest(".form-group").after(d)})},n.setMaxfiles=function(i,t){e("#"+i).data("maxfiles",t),n.AddCount=1},n.reset=function(i){e("input[id^="+i+"]").each(function(t,a){e(this).attr("id")!==i&&e(this).closest(".form-group").remove()}),e("#"+i).val(""),e("#"+i).closest(".form-group").find(".file-input-label").val(""),e("#"+i).data("filecount",1),n.AddCount=1},n.MaxFileCount=5,n.AddCount=1,n.init(),n});